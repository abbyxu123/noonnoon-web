<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NoonNoon v3</title>
  <style>
    :root{
      --bg1:#2b1f5a;
      --bg2:#3b2aa3;
      --glass: rgba(255,255,255,.12);
      --glass2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.18);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --muted2: rgba(255,255,255,.55);
      --accent: #c7b3ff;
      --btn: rgba(255,255,255,.14);
      --btn2: rgba(255,255,255,.18);
      --danger: rgba(255,120,120,.22);
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius: 22px;
      --radius2: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "SF Pro Display", "PingFang SC", "Microsoft YaHei", system-ui, sans-serif;
      min-height:100vh;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(155,110,255,.35), transparent 60%),
        radial-gradient(900px 500px at 90% 20%, rgba(120,170,255,.26), transparent 55%),
        radial-gradient(1200px 700px at 50% 110%, rgba(255,140,220,.18), transparent 60%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }
    .wrap{max-width:1120px;margin:0 auto;padding:22px 16px 56px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      gap:16px;margin-bottom:16px;
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:34px;height:34px;border-radius:12px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.7), rgba(255,255,255,.12));
      border:1px solid var(--stroke);
      box-shadow: 0 12px 24px rgba(0,0,0,.22);
    }
    .brand h1{font-size:20px;line-height:1.1;margin:0}
    .brand p{margin:2px 0 0 0;color:var(--muted2);font-size:12px}
    .pill{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.12);
      color:var(--muted);
      font-size:12px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .grid{
      display:grid;
      grid-template-columns: 1.25fr .85fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;inset:-2px;
      background: radial-gradient(600px 200px at 20% 0%, rgba(255,255,255,.10), transparent 55%);
      pointer-events:none;
    }
    .card-inner{position:relative;padding:18px}
    .hero h2{
      margin:0 0 6px 0;
      font-size:46px;
      letter-spacing:-.02em;
      line-height:1.05;
    }
    .hero .sub{
      color:var(--muted);
      margin:8px 0 12px 0;
      max-width:56ch;
      font-size:14px;
      line-height:1.55;
    }
    .caps{
      font-weight:600;
      letter-spacing:.14em;
      font-size:12px;
      color:var(--muted2);
      text-transform:uppercase;
      margin:10px 0 16px;
    }
    .btnrow{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    button,.btn{
      cursor:pointer;
      border:1px solid var(--stroke);
      background: var(--btn);
      color: var(--text);
      padding:12px 14px;
      border-radius: 999px;
      font-weight:650;
      font-size:14px;
      transition: .18s ease;
      display:inline-flex;align-items:center;gap:10px;
      user-select:none;
    }
    button:hover{transform: translateY(-1px); background: var(--btn2)}
    .danger{background: var(--danger)}
    .mutedNote{
      margin:10px 0 0 0;
      color:var(--muted2);
      font-size:12px;
    }
    .sideTitle{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-bottom:8px;
    }
    .sideTitle h3{margin:0;font-size:16px}
    .kv{
      display:grid;
      grid-template-columns: 92px 1fr;
      gap:8px 12px;
      padding-top:10px;
      font-size:13px;
      color:var(--muted);
    }
    .kv b{color:var(--muted2);font-weight:700}
    .kv .big{
      color:var(--text);
      line-height:1.5;
      white-space:pre-wrap;
    }
    .divider{height:1px;background:rgba(255,255,255,.12);margin:14px 0}
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
      margin-top:16px;
    }
    @media (max-width:980px){.row{grid-template-columns:1fr}}
    .sectionTitle{
      display:flex;align-items:center;gap:10px;margin:0 0 10px 0;
      color:var(--text);
      font-size:14px;
      font-weight:800;
    }
    .box{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.10);
      border-radius: 16px;
      padding:14px;
    }
    .box p{margin:0;color:var(--muted);font-size:13px;line-height:1.6}
    textarea,input,select{
      width:100%;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.14);
      color: var(--text);
      padding:12px 12px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:88px;resize:vertical}
    label{display:block;margin:10px 0 6px;color:var(--muted2);font-size:12px;font-weight:700}
    .small{
      font-size:12px;color:var(--muted2)
    }
    .out{
      white-space:pre-wrap;
      line-height:1.65;
      color: var(--text);
      font-size:14px;
    }
    .historyItem{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.10);
      border-radius: 16px;
      padding:12px;
      display:flex;justify-content:space-between;gap:12px;align-items:flex-start;
      cursor:pointer;
    }
    .historyItem:hover{background: rgba(0,0,0,.14)}
    .tag{
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: var(--muted);
      font-size:12px;font-weight:750;
      flex:0 0 auto;
    }
    .historyLeft{min-width:0}
    .historyLeft .t1{font-weight:850}
    .historyLeft .t2{color:var(--muted2);font-size:12px;margin-top:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:56ch}
    .fileInput{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>NoonNoon</h1>
          <p>See the patterns behind emotional loops.</p>
        </div>
      </div>
      <div class="pill">
        <span id="memCount">memory: 0</span>
        <span>â€¢</span>
        <span id="clock">--:--</span>
      </div>
    </div>

    <div class="grid">
      <!-- Left: Hero + Actions -->
      <div class="card hero">
        <div class="card-inner">
          <h2>Nothing is broken.<br/>We just havenâ€™t seen it clearly yet.</h2>
          <div class="sub">
            è¿™ä¸æ˜¯æ²»ç–—åº”ç”¨ã€‚å®ƒæ›´åƒä¸€ä¸ªâ€œç»“æ„åŒ–çœ‹è§è‡ªå·±â€çš„å·¥å…·ï¼šæŠŠæƒ…ç»ªã€è§¦å‘ç‚¹ã€éœ€æ±‚å’Œä¸€å¥æœ€æƒ³è¯´çš„è¯ï¼Œåšæˆå¯å›çœ‹çš„è®°å½•ã€‚
          </div>
          <div class="caps">A SYSTEM FOR UNDERSTANDING â€” ENABLING CONSCIOUS RESPONSE.</div>
          <div class="btnrow">
            <button id="btnStart">âœ¨ Start Check-in</button>
            <button id="btnCopy">ğŸ“‹ Copy last reply</button>
            <button class="danger" id="btnClear">ğŸ§¹ Clear memory</button>
          </div>
          <div class="mutedNote">ä½ çš„æ•°æ®é»˜è®¤åªä¿å­˜åœ¨ä½ è‡ªå·±çš„æµè§ˆå™¨é‡Œï¼ˆlocalStorageï¼‰ã€‚</div>
        </div>
      </div>

      <!-- Right: Last record + import/export -->
      <div class="card">
        <div class="card-inner">
          <div class="sideTitle">
            <h3>ğŸŒ™ æœ€è¿‘ä¸€æ¬¡å¯¹è¯ï¼ˆLast recordï¼‰</h3>
          </div>

          <div class="kv" id="lastKV">
            <b>æ—¶é—´</b><div class="big">â€”</div>
            <b>åå­—</b><div class="big">â€”</div>
            <b>å¯¹è±¡</b><div class="big">â€”</div>
            <b>å¿ƒæƒ…</b><div class="big">â€”</div>
            <b>ä¸€å¥è¯</b><div class="big">â€”</div>
          </div>

          <div class="divider"></div>

          <div class="btnrow">
            <button id="btnExport">â¬‡ï¸ Export JSON</button>
            <button id="btnImport">â¬†ï¸ Import JSON</button>
            <input class="fileInput" id="importFile" type="file" accept="application/json" />
          </div>
          <div class="small" style="margin-top:10px">
            Tipï¼šå¯¼å…¥ä¼šæŠŠæ–‡ä»¶é‡Œçš„è®°å½•åˆå¹¶è¿›å½“å‰ memoryï¼ˆä¸ä¼šæ¸…ç©ºä½ åŸæœ¬çš„ï¼Œé™¤éä½ ç‚¹ Clearï¼‰ã€‚
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <!-- Output -->
      <div class="card">
        <div class="card-inner">
          <div class="sectionTitle">ğŸ§  è¾“å‡ºï¼ˆGeneratedï¼‰</div>
          <div class="box">
            <div class="small" style="margin-bottom:10px">ç”Ÿæˆåä¼šæ˜¾ç¤º comfort + replyï¼Œå¹¶è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°è®°å¿†ã€‚</div>
            <div class="out" id="outText">â€”</div>
          </div>

          <div style="height:12px"></div>

          <div class="sectionTitle">ğŸ” çŠ¶æ€åˆ†æï¼ˆRoot Cause / Pattern / Adviceï¼‰</div>
          <div class="row" style="margin-top:0">
            <div class="box">
              <div class="small"><b>Root Cause</b>ï¼ˆæ ¹å› çŒœæµ‹ï¼‰</div>
              <p id="outRoot">â€”</p>
            </div>
            <div class="box">
              <div class="small"><b>Pattern</b>ï¼ˆä½ ä»¬çš„å¾ªç¯ï¼‰</div>
              <p id="outPattern">â€”</p>
            </div>
          </div>
          <div style="height:12px"></div>
          <div class="box">
            <div class="small"><b>Advice</b>ï¼ˆæ›´åƒâ€œä¸‹ä¸€æ­¥åŠ¨ä½œâ€ï¼‰</div>
            <p id="outAdvice">â€”</p>
          </div>
        </div>
      </div>

      <!-- Form + History -->
      <div class="card">
        <div class="card-inner">
          <div class="sectionTitle">ğŸ“ Check-in</div>

          <label>æˆ‘æ€ä¹ˆç§°å‘¼ä½ æ¯”è¾ƒèˆ’æœï¼Ÿ</label>
          <input id="inName" placeholder="æ¯”å¦‚ Abby / å°ç†Š / æˆ‘" />

          <label>ä½ ä»Šå¤©æœ€æƒ³å¯¹è°è¯´è¯´è¯ï¼Ÿ</label>
          <input id="inTarget" placeholder="æ¯”å¦‚ ç”·æœ‹å‹ / è‡ªå·± / å¦ˆå¦ˆ" />

          <label>å¦‚æœåªé€‰ä¸€ä¸ªè¯å½¢å®¹ç°åœ¨çš„çŠ¶æ€</label>
          <select id="inEmotion">
            <option value="">ï¼ˆéšä¾¿é€‰ï¼‰</option>
            <option>å¼€å¿ƒ</option><option>ç”Ÿæ°”</option><option>å§”å±ˆ</option><option>å¤±è½</option>
            <option>ç´¯</option><option>è¿·èŒ«</option><option>ç´§ç»·</option><option>ç„¦è™‘</option>
          </select>

          <label>æœ€è¿‘æœ€è®©ä½ å¡ä½/éš¾å—/æ”¾ä¸ä¸‹çš„ç‚¹</label>
          <textarea id="inReason" placeholder="å¯ä»¥éšä¾¿ç¢ç¢å¿µâ€¦"></textarea>

          <label>å¦‚æœå¯¹æ–¹åªèƒ½å¬ä½ ä¸€å¥è¯ï¼Œä½ æœ€æƒ³è®©TAå¬åˆ°å“ªä¸€å¥ï¼Ÿ</label>
          <textarea id="inWish" placeholder="è¯·è¾“è¿™å¥â€¦"></textarea>

          <div class="btnrow" style="margin-top:12px">
            <button id="btnGenerate">âœ… Generate</button>
            <button id="btnSaveOnly">ğŸ’¾ Save only</button>
          </div>

          <div class="divider"></div>

          <div class="sectionTitle">ğŸ—‚ï¸ å†å²è®°å½•ï¼ˆHistoryï¼‰</div>
          <div id="historyList" style="display:flex;flex-direction:column;gap:10px">
            <!-- items -->
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    // ====== Storage ======
    const KEY = "noonnoon_memory_v3";
    function nowStr(){
      const d = new Date();
      const pad = n => String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    function loadMemory(){
      try{
        const raw = localStorage.getItem(KEY);
        const data = raw ? JSON.parse(raw) : [];
        return Array.isArray(data) ? data : [];
      }catch(e){ return []; }
    }
    function saveMemory(mem){
      localStorage.setItem(KEY, JSON.stringify(mem, null, 2));
      refreshUI();
    }

    // ====== â€œchat.pyâ€ comfort mapping (ported) ======
    function comfortFor(emotion, target){
      if(!emotion) return "æˆ‘å¬åˆ°äº†ï¼Œä½ åˆšåˆšè¯´çš„æ¯ä¸€ä¸ªå­—ï¼Œå¯¹æˆ‘æ¥è¯´éƒ½å¾ˆé‡è¦ã€‚å³ä½¿ä½ ç°åœ¨å¾ˆéš¾ç”¨ä¸€ä¸ªè¯æ¦‚æ‹¬å¿ƒæƒ…ï¼Œä¹Ÿå®Œå…¨æ²¡å…³ç³»ã€‚";
      if(emotion.includes("å¼€å¿ƒ")) return `å¬èµ·æ¥ä½ ç°åœ¨æ˜¯åœ¨å¸¦ç€äº®äº®çš„å¿ƒæƒ…åœ¨è¯´è¿™äº›äº‹æƒ…ï¼Œæˆ‘æ›¿ ${target||"TA"} å·å·å¼€å¿ƒä¸€ä¸‹ï½`;
      if(emotion.includes("ç”Ÿæ°”")) return "æˆ‘èƒ½æ„Ÿå—åˆ°ä½ çœŸçš„å¾ˆæœ‰ç«æ°”ï¼Œä¸æ˜¯æ— ç†å–é—¹é‚£ç§ï¼Œè€Œæ˜¯è§‰å¾—è‡ªå·±è¢«å¿½è§† / ä¸è¢«ç†è§£ï¼Œä½ çš„æƒ…ç»ªæ˜¯å®Œå…¨åˆç†çš„ã€‚";
      if(emotion.includes("å§”å±ˆ")) return "å§”å±ˆè¿™ç§æƒ…ç»ªç‰¹åˆ«å¾®å¦™ï¼Œä½†å¾ˆçœŸå®ã€‚æˆ‘åœ¨è¿™è¾¹å…ˆæŠ±æŠ±ä½ ä¸€ä¸‹ï¼Œå†ä¸€èµ·çœ‹çœ‹æ€ä¹ˆæŠŠå®ƒè¯´æ¸…æ¥šï¼Œè€Œä¸æ˜¯ä¸€ç›´å‹åœ¨å¿ƒé‡Œã€‚";
      if(emotion.includes("å¤±è½")) return "æœ‰ä¸€ç‚¹æ‰ä¸‹æ¥çš„æ„Ÿè§‰å¯¹å—ï¼Ÿæˆ‘åœ¨ï¼Œå…ˆåˆ«æ€¥ç€è´£æ€ªè‡ªå·±ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆçœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆï¼Œå†æ…¢æ…¢æ‰¾å›ä¸€ç‚¹ç‚¹åŠ¨åŠ›ã€‚";
      if(emotion.includes("ç´¯")) return "è¾›è‹¦ä½ äº†ï¼Œè¿™ç§ç´¯ä¸ä»…æ˜¯èº«ä½“ï¼Œè¿˜æœ‰å¿ƒç†çš„è´Ÿè·ã€‚ä½ æ„¿æ„æŠŠè¿™äº›éƒ½è¯´å‡ºæ¥ï¼Œå·²ç»éå¸¸å‹‡æ•¢äº†ã€‚";
      if(emotion.includes("è¿·èŒ«")) return "è¿·èŒ«å…¶å®æ˜¯ä½ åœ¨å°è¯•çœ‹æ¸…æ–¹å‘çš„è¿‡ç¨‹ï¼Œè€Œä¸æ˜¯â€œå¤±è´¥â€ã€‚æˆ‘ä»¬å¯ä»¥ä¸€èµ·æŠŠé‚£äº›æ¨¡ç³Šçš„ä¸œè¥¿æ‹†å¼€ï¼Œä¸€ç‚¹ç‚¹çœ‹æ¸…æ¥šã€‚";
      if(emotion.includes("ç„¦è™‘") || emotion.includes("ç´§ç»·")) return "æˆ‘èƒ½æ„Ÿè§‰åˆ°ä½ ç°åœ¨å¾ˆç»·å¾ˆç´§ã€‚å…ˆä¸ç”¨é€¼è‡ªå·±åšâ€˜å®Œç¾å†³å®šâ€™ï¼Œæˆ‘ä»¬æŠŠé—®é¢˜æ‹†å°ï¼Œä¸‹ä¸€æ­¥åªåšä¸€ä»¶äº‹ã€‚";
      return "æˆ‘å¬åˆ°äº†ï¼Œä½ åˆšåˆšè¯´çš„æ¯ä¸€ä¸ªå­—ï¼Œå¯¹æˆ‘æ¥è¯´éƒ½å¾ˆé‡è¦ã€‚";
    }

    // ====== lightweight analysis (Root cause / Pattern / Advice) ======
    function analyze({emotion, reason, wish, target}){
      const emo = (emotion||"").trim();
      const r = (reason||"").trim();
      const w = (wish||"").trim();

      // Root Cause (heuristic)
      let root = "ä½ åœ¨è¿™æ®µå…³ç³»é‡Œæœ€æ ¸å¿ƒçš„éœ€æ±‚æ˜¯â€œè¢«çœ‹è§/è¢«å›åº”/è¢«æ”¾åœ¨å¿ƒä¸Šâ€ã€‚å½“å›åº”ç¼ºå¤±æ—¶ï¼Œå¤§è„‘ä¼šè‡ªåŠ¨æŠŠä¸ç¡®å®šæ€§æ”¾å¤§æˆå¨èƒæ„Ÿã€‚";
      if(emo.includes("ç”Ÿæ°”")) root = "ä½ ä¸æ˜¯å•çº¯åœ¨ç”Ÿæ°”ï¼Œè€Œæ˜¯åœ¨ä¿æŠ¤è¾¹ç•Œï¼šä½ éœ€è¦å°Šé‡ä¸æ¸…æ™°çš„æ²Ÿé€šï¼Œè€Œä¸æ˜¯è¢«æ™¾ç€ã€‚";
      if(emo.includes("å§”å±ˆ")) root = "å§”å±ˆé€šå¸¸æ¥è‡ªâ€œæˆ‘å·²ç»å¾ˆåŠªåŠ›äº†ï¼Œä½†å¯¹æ–¹æ²¡æ¥ä½â€ã€‚è¿™èƒŒåæ˜¯å¼ºçƒˆçš„è¿æ¥éœ€æ±‚ + å®³æ€•å¤±å»ã€‚";
      if(emo.includes("å¤±è½")) root = "å¤±è½å¸¸è§äºæœŸå¾…è½ç©ºï¼šä½ å¯¹æœªæ¥/å…³ç³»æœ‰æŠ•å…¥ï¼Œä½†ç›®å‰åé¦ˆä¸è¶³ï¼Œå¯¼è‡´èƒ½é‡å›æ”¶å¤±è´¥ã€‚";
      if(emo.includes("è¿·èŒ«")) root = "è¿·èŒ«å¤šåŠæ˜¯ä¿¡æ¯ä¸å®Œæ•´ï¼šä½ ä¸çŸ¥é“å¯¹æ–¹çœŸå®çŠ¶æ€/æ„å›¾ï¼Œäºæ˜¯ä½ æ— æ³•åšå‡ºç¨³å®šåˆ¤æ–­ã€‚";
      if(emo.includes("ç´¯")) root = "ä½ åœ¨é«˜è´Ÿè·çŠ¶æ€ä¸‹è¯•å›¾ç»´æŒå…³ç³»ç¨³å®šï¼Œè¿™ä¼šæŠŠâ€˜æ¢å¤â€™å’Œâ€˜å…³ç³»â€™ç»‘åœ¨ä¸€èµ·ï¼Œå¯¼è‡´æ›´ç´¯ã€‚";

      // Pattern
      let pattern = "å¾ªç¯å¤§æ¦‚æ˜¯ï¼šä½ æƒ³é è¿‘ â†’ å¾—ä¸åˆ°å›åº”/ä¸ç¡®å®š â†’ ä½ æ›´ç”¨åŠ›è§£é‡Š/è¯æ˜ â†’ å¯¹æ–¹å‹åŠ›ä¸Šå‡æˆ–ç»§ç»­æ²‰é»˜ â†’ ä½ æ›´ç„¦è™‘ã€‚";
      if(r.includes("ä¸å›") || r.includes("å¤±è¸ª") || r.includes("æ²‰é»˜")) pattern = "å¾ªç¯å¾ˆåƒï¼šä½ å‘å‡ºè¿æ¥ä¿¡å· â†’ å¯¹æ–¹æ²‰é»˜ â†’ ä½ å¼€å§‹è‡ªæˆ‘æ€€ç–‘/è„‘è¡¥ â†’ ä½ åŠ å¤§è¡¨è¾¾ â†’ å¯¹æ–¹æ›´å›é¿ã€‚";
      if(w.includes("éœ€è¦å›åº”")) pattern = "å¾ªç¯æ ¸å¿ƒç‚¹åœ¨â€œå›åº”ç¼ºå£â€ï¼šä½ è¦çš„æ˜¯ä¸€ä¸ªä¿¡å·ï¼ˆå“ªæ€•å¾ˆå°ï¼‰ï¼Œå¯¹æ–¹ç»™ä¸äº†æ—¶å°±ä¼šåå¤è§¦å‘ç„¦è™‘ã€‚";

      // Advice
      let advice = "ä¸‹ä¸€æ­¥åªåšä¸‰ä»¶äº‹ï¼š\n1) æŠŠä½ æƒ³è¦çš„â€˜å›åº”â€™å®šä¹‰å¾—æ›´å°ï¼ˆæ¯”å¦‚ï¼šä¸€å¥ç¡®è®¤/ä¸€ä¸ªæ—¶é—´ç‚¹ï¼‰ã€‚\n2) ç”¨ä¸€å¥è¯å‘å‡ºä½å‹åŠ›è¯·æ±‚ï¼ˆä¸è§£é‡Šã€ä¸æ§è¯‰ï¼‰ã€‚\n3) ç»™è‡ªå·±ä¸€ä¸ªè§‚å¯Ÿçª—å£ï¼ˆæ¯”å¦‚ 72 å°æ—¶ï¼‰ï¼Œçª—å£å†…ä¸è¿å‘ã€‚";
      if(emo.includes("ç”Ÿæ°”")) advice = "ä½ å¯ä»¥æŠŠè¡¨è¾¾ä»â€˜æƒ…ç»ªå¯¹æŠ—â€™åˆ‡åˆ°â€˜è§„åˆ™æ¸…æ™°â€™ï¼š\n- åªè¯´äº‹å® + éœ€æ±‚ + é€‰é¡¹ã€‚\nä¾‹ï¼šæˆ‘åœ¨æ„çš„æ˜¯å›åº”ã€‚å¦‚æœä½ éœ€è¦ç©ºé—´ï¼Œè¯·å‘Šè¯‰æˆ‘ä¸€ä¸ªä½ èƒ½å›å¤çš„æ—¶é—´ç‚¹ã€‚";
      if(emo.includes("è¿·èŒ«")) advice = "å…ˆè¡¥ä¿¡æ¯ï¼š\n- ä½ æœ€ç¼ºçš„ä¸æ˜¯â€œæ›´å¤šè¡¨è¾¾â€ï¼Œè€Œæ˜¯â€œæ˜ç¡®çŠ¶æ€â€ã€‚\n- ä½ å¯ä»¥è¯·æ±‚ä¸€ä¸ªæœ€å°ä¿¡æ¯ï¼šç°åœ¨æ˜¯å¦æ–¹ä¾¿æ²Ÿé€š/éœ€è¦å¤šä¹…ç©ºé—´/æ˜¯å¦å®‰å…¨ã€‚";
      return {root, pattern, advice};
    }

    // ====== UI ======
    const memCount = document.getElementById("memCount");
    const clock = document.getElementById("clock");
    const lastKV = document.getElementById("lastKV");
    const historyList = document.getElementById("historyList");

    const outText = document.getElementById("outText");
    const outRoot = document.getElementById("outRoot");
    const outPattern = document.getElementById("outPattern");
    const outAdvice = document.getElementById("outAdvice");

    const inName = document.getElementById("inName");
    const inTarget = document.getElementById("inTarget");
    const inEmotion = document.getElementById("inEmotion");
    const inReason = document.getElementById("inReason");
    const inWish = document.getElementById("inWish");

    function setClock(){
      const d = new Date();
      const pad = n => String(n).padStart(2,"0");
      clock.textContent = `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    setClock(); setInterval(setClock, 1000*15);

    function renderLast(mem){
      if(!mem.length){
        lastKV.innerHTML = `
          <b>æ—¶é—´</b><div class="big">â€”</div>
          <b>åå­—</b><div class="big">â€”</div>
          <b>å¯¹è±¡</b><div class="big">â€”</div>
          <b>å¿ƒæƒ…</b><div class="big">â€”</div>
          <b>ä¸€å¥è¯</b><div class="big">â€”</div>
        `;
        return;
      }
      const last = mem[mem.length-1];
      lastKV.innerHTML = `
        <b>æ—¶é—´</b><div class="big">${escapeHtml(last.time||"")}</div>
        <b>åå­—</b><div class="big">${escapeHtml(last.name||"")}</div>
        <b>å¯¹è±¡</b><div class="big">${escapeHtml(last.target||"")}</div>
        <b>å¿ƒæƒ…</b><div class="big">${escapeHtml(last.emotion||"")}</div>
        <b>ä¸€å¥è¯</b><div class="big">${escapeHtml(last.wish||"").slice(0,80)}${(last.wish||"").length>80?"â€¦":""}</div>
      `;
    }

    function renderHistory(mem){
      historyList.innerHTML = "";
      if(!mem.length){
        historyList.innerHTML = `<div class="small">è¿˜æ²¡æœ‰å†å²ã€‚ç‚¹ä¸€ä¸‹ â€œStart Check-inâ€ã€‚</div>`;
        return;
      }
      const last10 = mem.slice(-10).reverse();
      last10.forEach(item=>{
        const div = document.createElement("div");
        div.className = "historyItem";
        div.innerHTML = `
          <div class="historyLeft">
            <div class="t1">${escapeHtml(item.time||"")}&nbsp;Â·&nbsp;${escapeHtml(item.name||"")}&nbsp;Â·&nbsp;${escapeHtml(item.emotion||"")}</div>
            <div class="t2">Reasonï¼š${escapeHtml(item.reason||"â€”")}</div>
          </div>
          <div class="tag">${escapeHtml(item.target||"å¯¹è±¡")}</div>
        `;
        div.onclick = ()=>{
          // load into form
          inName.value = item.name||"";
          inTarget.value = item.target||"";
          inEmotion.value = item.emotion||"";
          inReason.value = item.reason||"";
          inWish.value = item.wish||"";
          // also render outputs if saved
          if(item._generated){
            outText.textContent = item._generated.reply || "â€”";
            outRoot.textContent = item._generated.root || "â€”";
            outPattern.textContent = item._generated.pattern || "â€”";
            outAdvice.textContent = item._generated.advice || "â€”";
          }
        };
        historyList.appendChild(div);
      });
    }

    function refreshUI(){
      const mem = loadMemory();
      memCount.textContent = `memory: ${mem.length}`;
      renderLast(mem);
      renderHistory(mem);

      if(mem.length && mem[mem.length-1]._generated){
        const g = mem[mem.length-1]._generated;
        outText.textContent = g.reply || "â€”";
        outRoot.textContent = g.root || "â€”";
        outPattern.textContent = g.pattern || "â€”";
        outAdvice.textContent = g.advice || "â€”";
      }
    }

    // ====== actions ======
    document.getElementById("btnStart").onclick = ()=>{
      // just scroll to form
      window.scrollTo({top: document.body.scrollHeight, behavior:"smooth"});
      inName.focus();
    };

    document.getElementById("btnClear").onclick = ()=>{
      if(confirm("ç¡®å®šæ¸…ç©ºæœ¬åœ° memory å—ï¼Ÿï¼ˆä¸å¯æ¢å¤ï¼‰")){
        localStorage.removeItem(KEY);
        outText.textContent = "â€”";
        outRoot.textContent = "â€”";
        outPattern.textContent = "â€”";
        outAdvice.textContent = "â€”";
        refreshUI();
      }
    };

    document.getElementById("btnCopy").onclick = async ()=>{
      const mem = loadMemory();
      const last = mem[mem.length-1];
      const text = last && last._generated && last._generated.reply ? last._generated.reply : outText.textContent;
      try{
        await navigator.clipboard.writeText(text || "");
        alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
      }catch(e){
        alert("å¤åˆ¶å¤±è´¥ï¼šæµè§ˆå™¨æƒé™é™åˆ¶ã€‚ä½ å¯ä»¥æ‰‹åŠ¨é€‰ä¸­æ–‡æœ¬å¤åˆ¶ã€‚");
      }
    };

    document.getElementById("btnExport").onclick = ()=>{
      const mem = loadMemory();
      const blob = new Blob([JSON.stringify(mem, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "noonnoon-memory.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    };

    const importFile = document.getElementById("importFile");
    document.getElementById("btnImport").onclick = ()=> importFile.click();
    importFile.onchange = async ()=>{
      const file = importFile.files && importFile.files[0];
      if(!file) return;
      try{
        const txt = await file.text();
        const data = JSON.parse(txt);
        if(!Array.isArray(data)) throw new Error("JSON ä¸æ˜¯æ•°ç»„");
        const mem = loadMemory();
        const merged = mem.concat(data);
        saveMemory(merged);
        alert("å¯¼å…¥æˆåŠŸï¼ˆå·²åˆå¹¶ï¼‰");
      }catch(e){
        alert("å¯¼å…¥å¤±è´¥ï¼š" + e.message);
      }finally{
        importFile.value = "";
      }
    };

    function buildReply({name, target, emotion, reason, wish}){
      const comfort = comfortFor(emotion, target);
      const reply = `â€”â€” æ¥è‡ªç°åœ¨çš„æˆ‘ï¼ˆç”± NoonNoon æš‚æ—¶ä»£ä½ ç¿»è¯‘ï¼‰â€”â€”

${name||"ä½ "}ï¼Œæˆ‘çŸ¥é“å½“é¢è¯´è¿™äº›æœ‰æ—¶å€™ä¼šå®¹æ˜“æƒ…ç»ªåŒ–ï¼Œæˆ–è€…è¢«å¿½ç•¥æˆâ€œçŸ«æƒ…â€ã€‚

ä½†å¦‚æœ ${target||"TA"} æ„¿æ„å¥½å¥½ç«™åœ¨ä½ è¿™è¾¹çœ‹ä¸€çœ¼ï¼Œåº”è¯¥ä¼šå‘ç°ï¼š

ã€Œ${reason||"ï¼ˆä½ è¿˜æ²¡å†™åŸå› ï¼‰"}ã€

è¿™å¥è¯å¯¹ä½ æ¥è¯´çœŸçš„å¾ˆé‡è¦ï¼Œå®ƒä¸æ˜¯æŒ‡è´£ï¼Œè€Œæ˜¯å¸Œæœ›è¢«çœ‹è§ã€è¢«ä½ åœ¨ä¹ã€‚

ä½ æœ€æƒ³è®©TAå¬åˆ°çš„ä¸€å¥è¯æ˜¯ï¼š
ã€Œ${wish||"ï¼ˆä½ è¿˜æ²¡å†™é‚£å¥è¯ï¼‰"}ã€

å¦‚æœæœ‰åˆé€‚çš„æ—¶æœºï¼Œä½ å¯ä»¥åœ¨ä¸é‚£ä¹ˆæƒ…ç»ªåŒ–çš„æ—¶å€™ï¼Œå¥½å¥½èŠèŠè¿™ä»¶äº‹ã€‚
è®©ä½ ä»¬ç«™åœ¨åŒä¸€è¾¹ï¼Œä¸€èµ·å¯¹æŠ—é—®é¢˜ï¼Œè€Œä¸æ˜¯äº’ç›¸å¯¹æŠ—ã€‚

â€”â€” ä¹Ÿæ˜¯ä¸ºäº†é‚£ä¸ªæ›´è½»æ¾ã€æ›´è¢«ç†è§£çš„ä½  ğŸ¤`;
      return {comfort, reply};
    }

    document.getElementById("btnSaveOnly").onclick = ()=>{
      const record = collectRecord(false);
      if(!record) return;
      const mem = loadMemory();
      mem.push(record);
      saveMemory(mem);
      alert("å·²ä¿å­˜åˆ° memoryï¼ˆæœªç”Ÿæˆè¾“å‡ºï¼‰");
    };

    document.getElementById("btnGenerate").onclick = ()=>{
      const record = collectRecord(true);
      if(!record) return;
      const mem = loadMemory();
      mem.push(record);
      saveMemory(mem);

      // render outputs
      outText.textContent = record._generated.reply;
      outRoot.textContent = record._generated.root;
      outPattern.textContent = record._generated.pattern;
      outAdvice.textContent = record._generated.advice;

      // top right last record auto refresh already
      window.scrollTo({top: 0, behavior:"smooth"});
    };

    function collectRecord(withGenerate){
      const name = inName.value.trim() || "";
      const target = inTarget.value.trim() || "";
      const emotion = inEmotion.value || "";
      const reason = inReason.value.trim() || "";
      const wish = inWish.value.trim() || "";

      if(!name && !target && !emotion && !reason && !wish){
        alert("ä½ è¿˜æ²¡å¡«å†…å®¹ã€‚éšä¾¿å¡«ä¸€ç‚¹ä¹Ÿè¡Œã€‚");
        return null;
      }

      const record = { time: nowStr(), name, target, emotion, reason, wish };
      if(withGenerate){
        const {comfort, reply} = buildReply(record);
        const a = analyze(record);
        record._generated = {
          comfort,
          reply: comfort + "\n\n" + reply,
          root: a.root,
          pattern: a.pattern,
          advice: a.advice
        };
      }
      return record;
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    // init
    refreshUI();
  </script>
</body>
</html>
