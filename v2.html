<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>NoonNoon â€” Emotional Check-in</title>
    <meta name="color-scheme" content="dark light" />
    <style>
      :root {
        --bg0: #0b0622;
        --bg1: #24106a;
        --bg2: #4b2bd6;
        --glass: rgba(255, 255, 255, 0.08);
        --glass-2: rgba(255, 255, 255, 0.12);
        --stroke: rgba(255, 255, 255, 0.18);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.72);
        --hint: rgba(255, 255, 255, 0.55);
        --shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
        --shadow-soft: 0 12px 40px rgba(0, 0, 0, 0.25);
        --radius: 20px;
        --radius-lg: 28px;
        --pad: 18px;
        --pad-lg: 26px;
        --max: 1080px;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        color: var(--text);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial,
          sans-serif;
        background: radial-gradient(
            1200px 800px at 25% 10%,
            rgba(170, 110, 255, 0.35),
            transparent 60%
          ),
          radial-gradient(
            900px 700px at 70% 35%,
            rgba(92, 180, 255, 0.18),
            transparent 58%
          ),
          radial-gradient(
            1000px 900px at 70% 95%,
            rgba(255, 160, 210, 0.14),
            transparent 60%
          ),
          linear-gradient(180deg, var(--bg0) 0%, var(--bg1) 50%, var(--bg2) 100%);
        overflow-x: hidden;
      }

      a {
        color: inherit;
      }

      .wrap {
        max-width: var(--max);
        margin: 0 auto;
        padding: 28px 18px 60px;
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 14px;
        margin-bottom: 14px;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 0;
      }

      .logo {
        width: 42px;
        height: 42px;
        border-radius: 14px;
        background: radial-gradient(
            14px 14px at 30% 35%,
            rgba(255, 255, 255, 0.95),
            rgba(255, 255, 255, 0.25)
          ),
          radial-gradient(
            26px 26px at 60% 65%,
            rgba(255, 210, 255, 0.55),
            rgba(255, 255, 255, 0.0)
          ),
          linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.06));
        border: 1px solid var(--stroke);
        box-shadow: var(--shadow-soft);
        position: relative;
        overflow: hidden;
      }

      .logo::after {
        content: "";
        position: absolute;
        inset: -40%;
        background: conic-gradient(
          from 180deg,
          rgba(255, 255, 255, 0),
          rgba(255, 255, 255, 0.35),
          rgba(255, 255, 255, 0)
        );
        filter: blur(2px);
        animation: spin 10s linear infinite;
        opacity: 0.7;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .brand h1 {
        font-size: 18px;
        margin: 0;
        letter-spacing: 0.2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .brand p {
        margin: 2px 0 0;
        font-size: 12px;
        color: var(--hint);
        letter-spacing: 0.2px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid var(--stroke);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
        backdrop-filter: blur(12px);
      }

      .pill small {
        color: var(--hint);
      }

      .hero {
        margin-top: 18px;
        border-radius: var(--radius-lg);
        padding: 26px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: linear-gradient(
            180deg,
            rgba(255, 255, 255, 0.10),
            rgba(255, 255, 255, 0.05)
          );
        box-shadow: var(--shadow);
        backdrop-filter: blur(16px);
        position: relative;
        overflow: hidden;
      }

      .hero::before {
        content: "";
        position: absolute;
        inset: -2px;
        background: radial-gradient(
            600px 420px at 20% 40%,
            rgba(255, 255, 255, 0.16),
            transparent 60%
          ),
          radial-gradient(
            520px 460px at 70% 30%,
            rgba(255, 210, 255, 0.12),
            transparent 62%
          ),
          radial-gradient(
            460px 520px at 70% 85%,
            rgba(120, 200, 255, 0.10),
            transparent 60%
          );
        filter: blur(8px);
        opacity: 0.9;
        pointer-events: none;
      }

      .stars {
        position: absolute;
        inset: 0;
        background-image: radial-gradient(
            rgba(255, 255, 255, 0.65) 1px,
            transparent 1px
          ),
          radial-gradient(
            rgba(255, 255, 255, 0.4) 1px,
            transparent 1px
          );
        background-size: 120px 120px, 180px 180px;
        background-position: 10px 20px, 60px 90px;
        opacity: 0.14;
        pointer-events: none;
      }

      .orbit {
        position: absolute;
        inset: -20%;
        border-radius: 50%;
        border: 1px solid rgba(255, 255, 255, 0.16);
        transform: rotate(12deg);
        filter: drop-shadow(0 0 22px rgba(255, 255, 255, 0.18));
        pointer-events: none;
      }

      .orbit::before,
      .orbit::after {
        content: "";
        position: absolute;
        inset: 12%;
        border-radius: 50%;
        border: 1px solid rgba(255, 255, 255, 0.12);
      }

      .orbit::after {
        inset: 24%;
        border-color: rgba(255, 255, 255, 0.10);
      }

      .heroGrid {
        display: grid;
        grid-template-columns: 1.15fr 0.85fr;
        gap: 18px;
        position: relative;
        z-index: 1;
      }

      @media (max-width: 920px) {
        .heroGrid {
          grid-template-columns: 1fr;
        }
      }

      .headline {
        padding: 2px 2px 0;
      }

      .headline h2 {
        margin: 0 0 10px;
        font-size: 34px;
        line-height: 1.12;
        letter-spacing: 0.2px;
      }

      .headline .tagline {
        margin: 0 0 16px;
        color: var(--muted);
        font-size: 14px;
        line-height: 1.6;
      }

      .quote {
        margin-top: 16px;
        border-left: 2px solid rgba(255, 255, 255, 0.25);
        padding-left: 12px;
        color: rgba(255, 255, 255, 0.78);
        font-weight: 600;
        letter-spacing: 0.6px;
        text-transform: uppercase;
        font-size: 12px;
      }

      .ctaRow {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 16px;
        align-items: center;
      }

      .btn {
        appearance: none;
        border: 1px solid rgba(255, 255, 255, 0.20);
        background: rgba(255, 255, 255, 0.10);
        color: var(--text);
        border-radius: 999px;
        padding: 12px 14px;
        font-weight: 700;
        letter-spacing: 0.2px;
        cursor: pointer;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.18);
        backdrop-filter: blur(12px);
        transition: transform 0.12s ease, background 0.12s ease, border 0.12s ease;
        display: inline-flex;
        align-items: center;
        gap: 10px;
      }

      .btn:hover {
        transform: translateY(-1px);
        background: rgba(255, 255, 255, 0.14);
        border-color: rgba(255, 255, 255, 0.28);
      }

      .btnPrimary {
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.22),
          rgba(255, 255, 255, 0.10)
        );
        border-color: rgba(255, 255, 255, 0.28);
      }

      .btnDanger {
        background: rgba(255, 90, 130, 0.12);
        border-color: rgba(255, 120, 150, 0.28);
      }

      .btnGhost {
        background: transparent;
        border-color: rgba(255, 255, 255, 0.16);
        box-shadow: none;
      }

      .card {
        border-radius: var(--radius);
        background: rgba(255, 255, 255, 0.07);
        border: 1px solid rgba(255, 255, 255, 0.16);
        box-shadow: var(--shadow-soft);
        backdrop-filter: blur(14px);
        padding: var(--pad-lg);
        position: relative;
        overflow: hidden;
      }

      .card h3 {
        margin: 0 0 12px;
        font-size: 14px;
        letter-spacing: 0.2px;
        color: rgba(255, 255, 255, 0.88);
      }

      .kv {
        display: grid;
        grid-template-columns: 88px 1fr;
        gap: 10px 12px;
        font-size: 13px;
        line-height: 1.55;
      }

      .k {
        color: var(--hint);
      }
      .v {
        color: rgba(255, 255, 255, 0.86);
        word-break: break-word;
      }

      .section {
        margin-top: 18px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }

      @media (max-width: 920px) {
        .section {
          grid-template-columns: 1fr;
        }
      }

      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
      }

      .muted {
        color: var(--hint);
      }

      .output {
        white-space: pre-wrap;
        line-height: 1.65;
        font-size: 13px;
        color: rgba(255, 255, 255, 0.90);
        background: rgba(0, 0, 0, 0.16);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 16px;
        padding: 14px;
      }

      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }

      .hr {
        height: 1px;
        background: rgba(255, 255, 255, 0.12);
        margin: 14px 0;
      }

      .list {
        display: grid;
        gap: 10px;
      }

      details {
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.05);
        overflow: hidden;
      }

      summary {
        cursor: pointer;
        padding: 12px 14px;
        list-style: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      summary::-webkit-details-marker {
        display: none;
      }

      .badge {
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(255, 255, 255, 0.06);
        color: rgba(255, 255, 255, 0.82);
        white-space: nowrap;
      }

      .detailBody {
        padding: 0 14px 14px;
      }

      .modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 18px;
        background: rgba(0, 0, 0, 0.45);
        z-index: 999;
      }

      .modal[open] {
        display: flex;
      }

      .modalPanel {
        width: min(820px, 100%);
        border-radius: 26px;
        background: linear-gradient(
            180deg,
            rgba(255, 255, 255, 0.12),
            rgba(255, 255, 255, 0.06)
          );
        border: 1px solid rgba(255, 255, 255, 0.18);
        box-shadow: var(--shadow);
        backdrop-filter: blur(16px);
        overflow: hidden;
        position: relative;
      }

      .modalPanel::before {
        content: "";
        position: absolute;
        inset: -30%;
        background: radial-gradient(
            520px 420px at 30% 30%,
            rgba(255, 255, 255, 0.16),
            transparent 60%
          ),
          radial-gradient(
            520px 520px at 70% 70%,
            rgba(255, 210, 255, 0.12),
            transparent 60%
          );
        filter: blur(12px);
        opacity: 0.95;
        pointer-events: none;
      }

      .modalHeader,
      .modalFooter {
        padding: 16px 18px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        position: relative;
        z-index: 1;
      }

      .modalHeader {
        border-bottom: 1px solid rgba(255, 255, 255, 0.12);
      }

      .modalHeader h4 {
        margin: 0;
        font-size: 14px;
        letter-spacing: 0.2px;
      }

      .modalBody {
        padding: 18px;
        position: relative;
        z-index: 1;
      }

      .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      @media (max-width: 720px) {
        .grid2 {
          grid-template-columns: 1fr;
        }
      }

      label {
        display: grid;
        gap: 6px;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.78);
      }

      input,
      textarea,
      select {
        width: 100%;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: rgba(0, 0, 0, 0.18);
        color: rgba(255, 255, 255, 0.92);
        padding: 10px 12px;
        outline: none;
        font-size: 14px;
      }

      textarea {
        min-height: 92px;
        resize: vertical;
      }

      .step {
        display: none;
      }
      .step[aria-hidden="false"] {
        display: block;
      }

      .tiny {
        font-size: 12px;
        color: var(--hint);
      }

      .footerNote {
        margin-top: 14px;
        color: rgba(255, 255, 255, 0.62);
        font-size: 12px;
        text-align: center;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div style="min-width: 0">
            <h1>NoonNoon</h1>
            <p>See the patterns behind emotional loops.</p>
          </div>
        </div>
        <div class="pill">
          <small class="mono" id="stat">memory: 0</small>
          <span class="badge mono" id="now">--:--</span>
        </div>
      </div>

      <section class="hero">
        <div class="stars" aria-hidden="true"></div>
        <div class="orbit" aria-hidden="true"></div>

        <div class="heroGrid">
          <div class="headline">
            <h2>Nothing is broken.<br />We just havenâ€™t seen it clearly yet.</h2>
            <p class="tagline">
              è¿™ä¸æ˜¯æ²»ç–—åº”ç”¨ã€‚å®ƒæ›´åƒä¸€ä¸ªâ€œç»“æ„åŒ–çœ‹è§è‡ªå·±â€çš„å·¥å…·ï¼šæŠŠæƒ…ç»ªã€è§¦å‘ç‚¹ã€éœ€æ±‚å’Œä¸€å¥æœ€æƒ³è¯´çš„è¯ï¼Œåšæˆå¯å›çœ‹çš„è®°å½•ã€‚
            </p>
            <div class="quote">A system for understanding â€” enabling conscious response.</div>
            <div class="ctaRow">
              <button class="btn btnPrimary" id="openCheckin">
                âœ¨ Start Check-in
              </button>
              <button class="btn btnGhost" id="copyLast" title="å¤åˆ¶æœ€è¿‘ä¸€æ¬¡å›å¤">
                ğŸ“‹ Copy last reply
              </button>
              <button class="btn btnDanger" id="clearAll" title="æ¸…ç©ºæœ¬åœ°è®°å¿†">
                ğŸ§¹ Clear memory
              </button>
            </div>
            <div class="footerNote">
              ä½ çš„æ•°æ®é»˜è®¤åªä¿å­˜åœ¨<strong>ä½ è‡ªå·±çš„æµè§ˆå™¨</strong>é‡Œï¼ˆlocalStorageï¼‰ã€‚
            </div>
          </div>

          <div class="card">
            <h3>ğŸŒ™ æœ€è¿‘ä¸€æ¬¡å¯¹è¯ï¼ˆLast recordï¼‰</h3>
            <div class="kv" id="lastKv">
              <div class="k">çŠ¶æ€</div>
              <div class="v muted">è¿˜æ²¡æœ‰è®°å½•ã€‚ç‚¹ Start Check-in å¼€å§‹ã€‚</div>
            </div>
            <div class="hr"></div>
            <div class="row">
              <button class="btn btnGhost" id="exportBtn">â¬‡ï¸ Export JSON</button>
              <label class="btn btnGhost" style="cursor: pointer">
                â¬†ï¸ Import JSON
                <input
                  id="importInput"
                  type="file"
                  accept="application/json"
                  style="display: none"
                />
              </label>
            </div>
          </div>
        </div>
      </section>

      <section class="section">
        <div class="card">
          <h3>ğŸ§  è¾“å‡ºï¼ˆGeneratedï¼‰</h3>
          <div class="tiny" id="genHint">
            ç”Ÿæˆåä¼šåœ¨è¿™é‡Œæ˜¾ç¤º comfort + replyï¼Œå¹¶è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°è®°å¿†ã€‚
          </div>
          <div class="hr"></div>
          <div class="output" id="comfortOut">ï¼ˆcomfort ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œï¼‰</div>
          <div class="hr"></div>
          <div class="output" id="replyOut">ï¼ˆreply ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œï¼‰</div>
          <div class="hr"></div>
          <div class="row">
            <button class="btn btnGhost" id="copyComfort">ğŸ“‹ Copy comfort</button>
            <button class="btn btnGhost" id="copyReply">ğŸ“‹ Copy reply</button>
          </div>
        </div>

        <div class="card">
          <h3>ğŸ“’ å†å²è®°å½•ï¼ˆHistoryï¼‰</h3>
          <div class="tiny">ç‚¹å‡»å±•å¼€å³å¯æŸ¥çœ‹æ¯æ¬¡çš„ç”Ÿæˆå†…å®¹ã€‚</div>
          <div class="hr"></div>
          <div class="list" id="historyList"></div>
        </div>
      </section>
    </div>

    <!-- Modal -->
    <dialog class="modal" id="modal">
      <div class="modalPanel" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modalHeader">
          <h4 id="modalTitle">NoonNoon Check-in</h4>
          <button class="btn btnGhost" id="closeModal">âœ–</button>
        </div>

        <div class="modalBody">
          <div class="tiny" id="stepHint"></div>
          <div class="hr"></div>

          <form id="checkinForm">
            <div class="step" id="step1" aria-hidden="false">
              <div class="grid2">
                <label>
                  æˆ‘æ€ä¹ˆç§°å‘¼ä½ æ¯”è¾ƒèˆ’æœï¼Ÿ
                  <input
                    name="name"
                    placeholder="æ¯”å¦‚ï¼šAbby / å°ç†Š / æˆ‘"
                    autocomplete="nickname"
                    required
                  />
                </label>
                <label>
                  ä½ ä»Šå¤©æœ€æƒ³å¯¹è°è¯´è¯´è¯ï¼Ÿ
                  <input
                    name="target"
                    placeholder="æ¯”å¦‚ï¼šç”·æœ‹å‹ / è‡ªå·± / å¦ˆå¦ˆ"
                    required
                  />
                </label>
              </div>
              <p class="tiny" style="margin: 10px 2px 0">
                è¿™ä¸¤é¡¹ç”¨äºç”Ÿæˆæ›´åƒâ€œä½ çš„è¯­æ°”â€çš„æ–‡æœ¬ã€‚
              </p>
            </div>

            <div class="step" id="step2" aria-hidden="true">
              <div class="grid2">
                <label>
                  å¦‚æœåªé€‰ä¸€ä¸ªè¯å½¢å®¹ç°åœ¨çŠ¶æ€
                  <select name="emotion" required>
                    <option value="" selected disabled>è¯·é€‰æ‹©</option>
                    <option value="å¼€å¿ƒ">å¼€å¿ƒ</option>
                    <option value="ç”Ÿæ°”">ç”Ÿæ°”</option>
                    <option value="å§”å±ˆ">å§”å±ˆ</option>
                    <option value="å¤±è½">å¤±è½</option>
                    <option value="ç´¯">ç´¯</option>
                    <option value="è¿·èŒ«">è¿·èŒ«</option>
                    <option value="è¯´ä¸æ¸…">è¯´ä¸æ¸…</option>
                  </select>
                </label>
                <label>
                  ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªè¯ï¼ˆå¯é€‰ï¼‰
                  <input name="emotion_custom" placeholder="æ¯”å¦‚ï¼šéº» / ç´§ç»· / å¿ƒè½¯" />
                </label>
              </div>

              <label style="margin-top: 12px">
                æœ€è¿‘æœ€è®©ä½ å¡ä½ / éš¾å— / æ”¾ä¸ä¸‹çš„ç‚¹
                <textarea
                  name="reason"
                  placeholder="å¯ä»¥éšä¾¿ç¢ç¢å¿µï¼šå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿä½ åœ¨æ„çš„æ˜¯ä»€ä¹ˆï¼Ÿ"
                  required
                ></textarea>
              </label>

              <label>
                å¦‚æœå¯¹æ–¹åªèƒ½å¬ä½ ä¸€å¥è¯ï¼Œä½ æœ€æƒ³è®© TA å¬åˆ°å“ªä¸€å¥ï¼Ÿ
                <textarea
                  name="wish"
                  placeholder="è¯·å†™è¿™ä¸€å¥ã€‚"
                  required
                ></textarea>
              </label>
            </div>
          </form>
        </div>

        <div class="modalFooter">
          <div class="row">
            <span class="badge mono" id="stepBadge">STEP 1/2</span>
            <span class="tiny" id="autosaveHint">ï¼ˆæäº¤åè‡ªåŠ¨ä¿å­˜ï¼‰</span>
          </div>
          <div class="row">
            <button class="btn btnGhost" id="prevBtn">â† Back</button>
            <button class="btn btnPrimary" id="nextBtn">Next â†’</button>
            <button class="btn btnPrimary" id="submitBtn" style="display: none">
              âœ¨ Generate
            </button>
          </div>
        </div>
      </div>
    </dialog>

    <script>
      "use strict";

      const STORAGE_KEY = "noonnoon_memory_v1";

      function pad2(n) {
        return String(n).padStart(2, "0");
      }

      function formatTime(d) {
        const y = d.getFullYear();
        const m = pad2(d.getMonth() + 1);
        const day = pad2(d.getDate());
        const hh = pad2(d.getHours());
        const mm = pad2(d.getMinutes());
        const ss = pad2(d.getSeconds());
        return `${y}-${m}-${day} ${hh}:${mm}:${ss}`;
      }

      function loadMemory() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return [];
          const data = JSON.parse(raw);
          return Array.isArray(data) ? data : [];
        } catch (e) {
          return [];
        }
      }

      function saveMemory(list) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
      }

      function buildComfort(emotion, target) {
        const e = emotion || "";
        const t = target || "TA";
        if (e.includes("å¼€å¿ƒ")) {
          return `å¬èµ·æ¥ä½ ç°åœ¨æ˜¯åœ¨å¸¦ç€äº®äº®çš„å¿ƒæƒ…åœ¨è¯´è¿™äº›äº‹æƒ…ï¼Œæˆ‘æ›¿ ${t} å·å·å¼€å¿ƒä¸€ä¸‹ï½`;
        }
        if (e.includes("ç”Ÿæ°”")) {
          return "æˆ‘èƒ½æ„Ÿå—åˆ°ä½ çœŸçš„å¾ˆæœ‰ç«æ°”ï¼Œä¸æ˜¯æ— ç†å–é—¹é‚£ç§ï¼Œè€Œæ˜¯è§‰å¾—è‡ªå·±è¢«å¿½è§† / ä¸è¢«ç†è§£ï¼Œä½ çš„æƒ…ç»ªæ˜¯å®Œå…¨åˆç†çš„ã€‚";
        }
        if (e.includes("å§”å±ˆ")) {
          return "å§”å±ˆè¿™ç§æƒ…ç»ªç‰¹åˆ«å¾®å¦™ï¼Œä½†å¾ˆçœŸå®ã€‚æˆ‘åœ¨è¿™è¾¹å…ˆæŠ±æŠ±ä½ ä¸€ä¸‹ï¼Œå†ä¸€èµ·çœ‹çœ‹æ€ä¹ˆæŠŠå®ƒè¯´æ¸…æ¥šï¼Œè€Œä¸æ˜¯ä¸€ç›´å‹åœ¨å¿ƒé‡Œã€‚";
        }
        if (e.includes("å¤±è½")) {
          return "æœ‰ä¸€ç‚¹æ‰ä¸‹æ¥çš„æ„Ÿè§‰å¯¹å—ï¼Ÿæˆ‘åœ¨ï¼Œå…ˆåˆ«æ€¥ç€è´£æ€ªè‡ªå·±ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆçœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆï¼Œå†æ…¢æ…¢æ‰¾å›ä¸€ç‚¹ç‚¹åŠ¨åŠ›ã€‚";
        }
        if (e.includes("ç´¯")) {
          return "è¾›è‹¦ä½ äº†ï¼Œè¿™ç§ç´¯ä¸ä»…æ˜¯èº«ä½“ï¼Œè¿˜æœ‰å¿ƒç†çš„è´Ÿè·ã€‚ä½ æ„¿æ„æŠŠè¿™äº›éƒ½è¯´å‡ºæ¥ï¼Œå·²ç»éå¸¸å‹‡æ•¢äº†ã€‚";
        }
        if (e.includes("è¿·èŒ«")) {
          return "è¿·èŒ«å…¶å®æ˜¯ä½ åœ¨å°è¯•çœ‹æ¸…æ–¹å‘çš„è¿‡ç¨‹ï¼Œè€Œä¸æ˜¯â€œå¤±è´¥â€ã€‚æˆ‘ä»¬å¯ä»¥ä¸€èµ·æŠŠé‚£äº›æ¨¡ç³Šçš„ä¸œè¥¿æ‹†å¼€ï¼Œä¸€ç‚¹ç‚¹çœ‹æ¸…æ¥šã€‚";
        }
        return "æˆ‘å¬åˆ°äº†ï¼Œä½ åˆšåˆšè¯´çš„æ¯ä¸€ä¸ªå­—ï¼Œå¯¹æˆ‘æ¥è¯´éƒ½å¾ˆé‡è¦ã€‚å³ä½¿ä½ ç°åœ¨å¾ˆéš¾ç”¨ä¸€ä¸ªè¯æ¦‚æ‹¬å¿ƒæƒ…ï¼Œä¹Ÿå®Œå…¨æ²¡å…³ç³»ã€‚";
      }

      function buildReply({ name, target, reason }) {
        const n = name || "ä½ ";
        const t = target || "TA";
        const r = reason || "";
        return `â€”â€” æ¥è‡ªç°åœ¨çš„æˆ‘ï¼ˆç”± NoonNoon æš‚æ—¶ä»£ä½ ç¿»è¯‘ï¼‰â€”â€”

${n}ï¼Œæˆ‘çŸ¥é“å½“é¢è¯´è¿™äº›æœ‰æ—¶å€™ä¼šå®¹æ˜“æƒ…ç»ªåŒ–ï¼Œæˆ–è€…è¢«å¿½ç•¥æˆâ€œçŸ«æƒ…â€ã€‚

ä½†å¦‚æœ ${t} æ„¿æ„å¥½å¥½ç«™åœ¨ä½ è¿™è¾¹çœ‹ä¸€çœ¼ï¼Œåº”è¯¥ä¼šå‘ç°ï¼š

ã€Œ${r}ã€

è¿™å¥è¯å¯¹ä½ æ¥è¯´çœŸçš„å¾ˆé‡è¦ï¼Œå®ƒä¸æ˜¯æŒ‡è´£ï¼Œè€Œæ˜¯å¸Œæœ›è¢«çœ‹è§ã€è¢«ä½ åœ¨ä¹ã€‚

å¦‚æœæœ‰åˆé€‚çš„æ—¶æœºï¼Œä½ å¯ä»¥åœ¨ä¸é‚£ä¹ˆæƒ…ç»ªåŒ–çš„æ—¶å€™ï¼Œå¥½å¥½èŠèŠè¿™ä»¶äº‹ã€‚
è®©ä½ ä»¬ç«™åœ¨åŒä¸€è¾¹ï¼Œä¸€èµ·å¯¹æŠ—é—®é¢˜ï¼Œè€Œä¸æ˜¯äº’ç›¸å¯¹æŠ—ã€‚

â€”â€” ä¹Ÿæ˜¯ä¸ºäº†é‚£ä¸ªæ›´è½»æ¾ã€æ›´è¢«ç†è§£çš„ä½  ğŸ¤`;
      }

      function safeText(s) {
        return (s ?? "").toString();
      }

      function downloadText(filename, text) {
        const blob = new Blob([text], { type: "application/json;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      async function copyToClipboard(text) {
        const t = safeText(text);
        if (!t) return;
        try {
          await navigator.clipboard.writeText(t);
        } catch (e) {
          const ta = document.createElement("textarea");
          ta.value = t;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          ta.remove();
        }
      }

      // ----- UI wiring -----
      const el = {
        stat: document.getElementById("stat"),
        now: document.getElementById("now"),
        lastKv: document.getElementById("lastKv"),
        comfortOut: document.getElementById("comfortOut"),
        replyOut: document.getElementById("replyOut"),
        historyList: document.getElementById("historyList"),

        modal: document.getElementById("modal"),
        openCheckin: document.getElementById("openCheckin"),
        closeModal: document.getElementById("closeModal"),

        prevBtn: document.getElementById("prevBtn"),
        nextBtn: document.getElementById("nextBtn"),
        submitBtn: document.getElementById("submitBtn"),
        stepBadge: document.getElementById("stepBadge"),
        stepHint: document.getElementById("stepHint"),

        step1: document.getElementById("step1"),
        step2: document.getElementById("step2"),
        form: document.getElementById("checkinForm"),

        copyLast: document.getElementById("copyLast"),
        copyComfort: document.getElementById("copyComfort"),
        copyReply: document.getElementById("copyReply"),

        exportBtn: document.getElementById("exportBtn"),
        importInput: document.getElementById("importInput"),
        clearAll: document.getElementById("clearAll"),
      };

      let memory = loadMemory();
      let step = 1;

      function tickClock() {
        const d = new Date();
        el.now.textContent = `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
      }

      function setStep(n) {
        step = n;
        const s1 = step === 1;
        el.step1.setAttribute("aria-hidden", String(!s1));
        el.step2.setAttribute("aria-hidden", String(s1));
        el.prevBtn.style.visibility = s1 ? "hidden" : "visible";
        el.nextBtn.style.display = s1 ? "inline-flex" : "none";
        el.submitBtn.style.display = s1 ? "none" : "inline-flex";
        el.stepBadge.textContent = `STEP ${step}/2`;
        el.stepHint.textContent =
          step === 1
            ? "å…ˆå¡«ä¸¤ä¸ªæœ€åŸºç¡€çš„ä¿¡æ¯ï¼šç§°å‘¼ä½ ã€ä½ æƒ³å¯¹è°è¯´ã€‚"
            : "å†æŠŠæƒ…ç»ª + å¡ä½çš„ç‚¹ + ä¸€å¥è¯æ„¿æœ›å†™ä¸‹æ¥ã€‚";
      }

      function renderLast() {
        if (!memory.length) {
          el.lastKv.innerHTML = `
            <div class="k">çŠ¶æ€</div>
            <div class="v muted">è¿˜æ²¡æœ‰è®°å½•ã€‚ç‚¹ Start Check-in å¼€å§‹ã€‚</div>
          `;
          return;
        }
        const last = memory[memory.length - 1];
        el.lastKv.innerHTML = `
          <div class="k">æ—¶é—´</div><div class="v mono">${safeText(last.time)}</div>
          <div class="k">åå­—</div><div class="v">${safeText(last.name)}</div>
          <div class="k">å¯¹è±¡</div><div class="v">${safeText(last.target)}</div>
          <div class="k">å¿ƒæƒ…</div><div class="v">${safeText(last.emotion)}</div>
          <div class="k">ä¸€å¥è¯</div><div class="v">${safeText(last.wish)}</div>
        `;
      }

      function renderStats() {
        el.stat.textContent = `memory: ${memory.length}`;
      }

      function renderHistory() {
        if (!memory.length) {
          el.historyList.innerHTML = `<div class="muted tiny">æš‚æ— è®°å½•ã€‚</div>`;
          return;
        }

        const items = memory
          .slice()
          .reverse()
          .map((rec, idxFromEnd) => {
            const idx = memory.length - 1 - idxFromEnd;
            const title = `${safeText(rec.time)} Â· ${safeText(rec.name)} Â· ${safeText(
              rec.emotion
            )}`;
            const badge = safeText(rec.target || "TA");
            return `
              <details>
                <summary>
                  <div style="min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                    ${title}
                  </div>
                  <span class="badge">${badge}</span>
                </summary>
                <div class="detailBody">
                  <div class="kv">
                    <div class="k">Reason</div><div class="v">${safeText(rec.reason)}</div>
                    <div class="k">Wish</div><div class="v">${safeText(rec.wish)}</div>
                  </div>
                  <div class="hr"></div>
                  <div class="tiny muted">Comfort</div>
                  <div class="output" style="margin-top:8px">${safeText(rec.comfort)}</div>
                  <div class="hr"></div>
                  <div class="tiny muted">Reply</div>
                  <div class="output" style="margin-top:8px">${safeText(rec.reply)}</div>
                  <div class="hr"></div>
                  <div class="row">
                    <button class="btn btnGhost" data-act="use" data-idx="${idx}">â†ª Use as last</button>
                    <button class="btn btnGhost" data-act="copy" data-idx="${idx}">ğŸ“‹ Copy reply</button>
                    <button class="btn btnDanger" data-act="del" data-idx="${idx}">ğŸ—‘ Delete</button>
                  </div>
                </div>
              </details>
            `;
          })
          .join("");

        el.historyList.innerHTML = items;

        el.historyList.querySelectorAll("button[data-act]").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            e.preventDefault();
            e.stopPropagation();
            const act = btn.getAttribute("data-act");
            const idx = Number(btn.getAttribute("data-idx"));
            const rec = memory[idx];
            if (!rec) return;

            if (act === "del") {
              memory.splice(idx, 1);
              saveMemory(memory);
              rerenderAll();
              return;
            }

            if (act === "copy") {
              await copyToClipboard(rec.reply);
              return;
            }

            if (act === "use") {
              el.comfortOut.textContent = safeText(rec.comfort);
              el.replyOut.textContent = safeText(rec.reply);
              return;
            }
          });
        });
      }

      function rerenderAll() {
        renderStats();
        renderLast();
        renderHistory();
      }

      function openModal() {
        setStep(1);
        el.modal.setAttribute("open", "");
        el.form.reset();
        const first = el.form.querySelector('input[name="name"]');
        if (first) first.focus();
      }

      function closeModal() {
        el.modal.removeAttribute("open");
      }

      function getFormData() {
        const fd = new FormData(el.form);
        const name = safeText(fd.get("name")).trim();
        const target = safeText(fd.get("target")).trim();
        const emotionPick = safeText(fd.get("emotion")).trim();
        const emotionCustom = safeText(fd.get("emotion_custom")).trim();
        const emotion = emotionCustom || emotionPick;
        const reason = safeText(fd.get("reason")).trim();
        const wish = safeText(fd.get("wish")).trim();

        if (!name) throw new Error("è¯·å¡«å†™ï¼šç§°å‘¼ä½ ï¼ˆnameï¼‰");
        if (!target) throw new Error("è¯·å¡«å†™ï¼šä½ æƒ³å¯¹è°è¯´ï¼ˆtargetï¼‰");
        if (!emotion) throw new Error("è¯·å¡«å†™ï¼šæƒ…ç»ªï¼ˆemotionï¼‰");
        if (!reason) throw new Error("è¯·å¡«å†™ï¼šå¡ä½çš„ç‚¹ï¼ˆreasonï¼‰");
        if (!wish) throw new Error("è¯·å¡«å†™ï¼šä¸€å¥è¯ï¼ˆwishï¼‰");

        return { name, target, emotion, reason, wish };
      }

      function generateAndSave(data) {
        const comfort = buildComfort(data.emotion, data.target);
        const reply = buildReply(data);
        const record = {
          time: formatTime(new Date()),
          ...data,
          comfort,
          reply,
        };

        memory.push(record);
        saveMemory(memory);

        el.comfortOut.textContent = comfort;
        el.replyOut.textContent = reply;

        rerenderAll();
      }

      // ----- events -----
      el.openCheckin.addEventListener("click", openModal);
      el.closeModal.addEventListener("click", closeModal);
      el.modal.addEventListener("click", (e) => {
        if (e.target === el.modal) closeModal();
      });

      el.prevBtn.addEventListener("click", (e) => {
        e.preventDefault();
        setStep(1);
      });

      el.nextBtn.addEventListener("click", (e) => {
        e.preventDefault();
        try {
          const fd = new FormData(el.form);
          const name = safeText(fd.get("name")).trim();
          const target = safeText(fd.get("target")).trim();
          if (!name || !target) throw new Error("å…ˆæŠŠ STEP 1 çš„ä¸¤é¡¹å¡«å®Œã€‚");
          setStep(2);
        } catch (err) {
          alert(err.message || String(err));
        }
      });

      el.submitBtn.addEventListener("click", (e) => {
        e.preventDefault();
        try {
          const data = getFormData();
          generateAndSave(data);
          closeModal();
        } catch (err) {
          alert(err.message || String(err));
        }
      });

      el.copyComfort.addEventListener("click", async () => {
        await copyToClipboard(el.comfortOut.textContent);
      });

      el.copyReply.addEventListener("click", async () => {
        await copyToClipboard(el.replyOut.textContent);
      });

      el.copyLast.addEventListener("click", async () => {
        if (!memory.length) return alert("è¿˜æ²¡æœ‰è®°å½•ã€‚");
        await copyToClipboard(memory[memory.length - 1].reply);
      });

      el.exportBtn.addEventListener("click", () => {
        const ts = formatTime(new Date()).replace(/[ :]/g, "-");
        downloadText(`noonnoon-memory-${ts}.json`, JSON.stringify(memory, null, 2));
      });

      el.importInput.addEventListener("change", async () => {
        const file = el.importInput.files && el.importInput.files[0];
        if (!file) return;
        try {
          const text = await file.text();
          const data = JSON.parse(text);
          if (!Array.isArray(data)) throw new Error("JSON æ ¼å¼ä¸å¯¹ï¼šåº”è¯¥æ˜¯æ•°ç»„ã€‚");
          memory = data;
          saveMemory(memory);
          rerenderAll();
          alert("å¯¼å…¥æˆåŠŸ âœ…");
        } catch (err) {
          alert(`å¯¼å…¥å¤±è´¥ï¼š${err.message || err}`);
        } finally {
          el.importInput.value = "";
        }
      });

      el.clearAll.addEventListener("click", () => {
        if (!confirm("ç¡®å®šæ¸…ç©ºæœ¬åœ°æ‰€æœ‰è®°å¿†ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) return;
        memory = [];
        saveMemory(memory);
        el.comfortOut.textContent = "ï¼ˆcomfort ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œï¼‰";
        el.replyOut.textContent = "ï¼ˆreply ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œï¼‰";
        rerenderAll();
      });

      // init
      setStep(1);
      tickClock();
      setInterval(tickClock, 1000 * 20);
      rerenderAll();
    </script>
  </body>
</html>
